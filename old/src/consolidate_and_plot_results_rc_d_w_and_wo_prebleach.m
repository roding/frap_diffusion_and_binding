clear
clc
close all hidden

addpath('signal');
addpath('estimation');

%% Load data.
% 
% main_folder_lantmannen = '/home/sms/magnusro/frap_aka_20180309/';
% 
% file_paths = {  [main_folder_lantmannen 'FRAP inm Visk 45 deg t0/frap.mat'], ...
%                 [main_folder_lantmannen 'FRAP inm Visk 45 deg t0/frap_001.mat'], ...
%                 [main_folder_lantmannen 'FRAP inm Visk 45 deg t0/frap_002.mat'], ...
%                 [main_folder_lantmannen 'FRAP inm Visk 45 deg t0/frap_003.mat'], ...
%                 [main_folder_lantmannen 'FRAP inm Visk 45 deg t0/frap_004.mat'], ...
%                 [main_folder_lantmannen 'FRAP inm Visk 45 deg t0/frap_005.mat'], ...
%                 [main_folder_lantmannen 'FRAP inm Visk 45 deg t3/frap.mat'], ...
%                 [main_folder_lantmannen 'FRAP inm Visk 45 deg t3/frap_001.mat'], ...
%                 [main_folder_lantmannen 'FRAP inm Visk 45 deg t3/frap_002.mat'], ...
%                 [main_folder_lantmannen 'FRAP inm Visk 45 deg t3/frap_003.mat'], ...
%                 [main_folder_lantmannen 'FRAP inm Visk 45 deg t3/frap_004.mat'], ...
%                 [main_folder_lantmannen 'FRAP inm Visk 45 deg t3/frap_005.mat'], ...
%                 [main_folder_lantmannen 'FRAP inm Visk 45 deg t20/frap.mat'], ...
%                 [main_folder_lantmannen 'FRAP inm Visk 45 deg t20/frap_001.mat'], ...
%                 [main_folder_lantmannen 'FRAP inm Visk 45 deg t20/frap_002.mat'], ...
%                 [main_folder_lantmannen 'FRAP inm Visk 45 deg t20/frap_003.mat'], ...
%                 [main_folder_lantmannen 'FRAP inm Visk 45 deg t20/frap_004.mat'], ...
%                 [main_folder_lantmannen 'FRAP inm Visk 45 deg t20/frap_005.mat'], ...
%                 [main_folder_lantmannen 'FRAP FITC 0,01 45 deg t0/frap.mat'], ...
%                 [main_folder_lantmannen 'FRAP FITC 0,01 45 deg t0/frap_001.mat'], ...
%                 [main_folder_lantmannen 'FRAP FITC 0,01 45 deg t0/frap_002.mat'], ...
%                 [main_folder_lantmannen 'FRAP FITC 0,01 45 deg t0/frap_003.mat'], ...
%                 [main_folder_lantmannen 'FRAP FITC 0,01 45 deg t0/frap_004.mat'], ...
%                 [main_folder_lantmannen 'FRAP FITC 0,01 45 deg t0/frap_005.mat'], ...
%                 [main_folder_lantmannen 'FRAP FITC 0,01 45 deg t3/frap.mat'], ...
%                 [main_folder_lantmannen 'FRAP FITC 0,01 45 deg t3/frap_001.mat'], ...
%                 [main_folder_lantmannen 'FRAP FITC 0,01 45 deg t3/frap_002.mat'], ...
%                 [main_folder_lantmannen 'FRAP FITC 0,01 45 deg t3/frap_003.mat'], ...
%                 [main_folder_lantmannen 'inm visc ror2/frap.mat'], ...
%                 [main_folder_lantmannen 'inm visc ror2/frap_001.mat'], ...
%                 [main_folder_lantmannen 'inm visc ror2/frap_002.mat'], ...
%                 [main_folder_lantmannen 'inm visc ror2/frap_003.mat'], ...
%                 [main_folder_lantmannen 'inm visc ror1/frap.mat'], ...
%                 [main_folder_lantmannen 'inm visc ror1/frap_001.mat'], ...
%                 [main_folder_lantmannen 'inm visc ror1/frap_002.mat'], ...
%                 [main_folder_lantmannen 'inm visc ror1/frap_003.mat'], ...
%                 [main_folder_lantmannen 'filtrat FITC/frap.mat'], ...
%                 [main_folder_lantmannen 'filtrat FITC/frap_001.mat'], ...
%                 [main_folder_lantmannen 'filtrat FITC/frap_002.mat'], ...
%                 [main_folder_lantmannen 'filtrat FITC/frap_003.mat'], ...
%                 [main_folder_lantmannen 'FITC i HEPES 170418/frap.mat'], ...
%                 [main_folder_lantmannen 'FITC i HEPES 170418/frap_001.mat'], ...
%                 [main_folder_lantmannen 'FITC i HEPES 170418/frap_002.mat'], ...
%                 [main_folder_lantmannen 'FITC i HEPES 170418/frap_003.mat'], ...
%                 [main_folder_lantmannen '0,01 mg FITC i HEPES/frap.mat'], ...
%                 [main_folder_lantmannen '0,01 mg FITC i HEPES/frap_001.mat'], ...
%                 [main_folder_lantmannen '0,01 mg FITC i HEPES/frap_002.mat'], ...
%                 [main_folder_lantmannen '0,01 mg FITC i HEPES/frap_003.mat'], ...
%                 [main_folder_lantmannen '0,1 mg FITC + omarkt visc/frap.mat'], ...
%                 [main_folder_lantmannen '0,1 mg FITC + omarkt visc/frap_001.mat'], ...
%                 [main_folder_lantmannen '0,1 mg FITC + omarkt visc/frap_002.mat'], ...
%                 [main_folder_lantmannen '0,1 mg FITC + omarkt visc/frap_003.mat']};
%             
% main_folder_lantmannen = '/home/sms/magnusro/frap_aka_20180319/';
% 
% file_paths = {  [main_folder_lantmannen '50-40-5-5 137 2-1/frap.mat'], ...
%                 [main_folder_lantmannen '50-40-5-5 137 2-1/frap_001.mat'], ...
%                 [main_folder_lantmannen '50-40-5-5 137 2-1/frap_002.mat'], ...
%                 [main_folder_lantmannen '50-40-5-5 137 2-1/frap_003.mat'], ...
%                 [main_folder_lantmannen '50-40-5-5 137 2-1/frap_004.mat'], ...
%                 [main_folder_lantmannen '50-40-5-5 137 2-1/frap_005.mat'], ...
%                 [main_folder_lantmannen '50-40-5-5 137 2-1/frap_006.mat'], ...
%                 [main_folder_lantmannen '50-40-5-5 137 2-1/frap_007.mat'], ...
%                 [main_folder_lantmannen '50-40-5-5 137 2-1/frap_008.mat'], ...
%                 [main_folder_lantmannen '50-40-5-5 137 2-1/frap_009.mat'], ...
%                 [main_folder_lantmannen '50-40-5-5 137 2-1/frap_010.mat'], ...
%                 [main_folder_lantmannen '50-45-5 132 1-1/frap.mat'], ...
%                 [main_folder_lantmannen '50-45-5 132 1-1/frap_001.mat'], ...
%                 [main_folder_lantmannen '50-45-5 132 1-1/frap_002.mat'], ...
%                 [main_folder_lantmannen '50-45-5 132 1-1/frap_003.mat'], ...
%                 [main_folder_lantmannen '50-45-5 132 1-1/frap_004.mat'], ...
%                 [main_folder_lantmannen '50-45-5 132 1-1/frap_005.mat'], ...
%                 [main_folder_lantmannen '50-45-5 132 1-1/frap_006.mat'], ...
%                 [main_folder_lantmannen '50-45-5 132 1-1/frap_007.mat'], ...
%                 [main_folder_lantmannen '50-45-5 180 1-2/frap.mat'], ...
%                 [main_folder_lantmannen '50-45-5 180 1-2/frap_001.mat'], ...
%                 [main_folder_lantmannen '50-45-5 180 1-2/frap_002.mat'], ...
%                 [main_folder_lantmannen '50-45-5 180 1-2/frap_003.mat'], ...
%                 [main_folder_lantmannen '50-45-5 180 1-2/frap_004.mat'], ...
%                 [main_folder_lantmannen '50-45-5 180 1-2/frap_005.mat'], ...
%                 [main_folder_lantmannen '50-45-5 180 1-2/frap_006.mat'], ...
%                 [main_folder_lantmannen '50-45-5 180 1-2/frap_007.mat'], ...
%                 [main_folder_lantmannen 'buffertar/frap.mat'], ...
%                 [main_folder_lantmannen 'buffertar/frap_001.mat'], ...
%                 [main_folder_lantmannen 'buffertar/frap_002.mat'], ...
%                 [main_folder_lantmannen 'buffertar/frap_003.mat'], ...
%                 [main_folder_lantmannen 'buffertar/frap_004.mat'], ...
%                 [main_folder_lantmannen 'buffertar/frap_005.mat']};

main_folder_lantmannen = '/home/sms/magnusro/frap_aka_20180319/';

file_paths = {  [main_folder_lantmannen '50-40-5-5 137 2-1/frap.mat'], ...
                [main_folder_lantmannen '50-40-5-5 137 2-1/frap_001.mat'], ...
                [main_folder_lantmannen '50-40-5-5 137 2-1/frap_002.mat'], ...
                [main_folder_lantmannen '50-40-5-5 137 2-1/frap_003.mat'], ...
                [main_folder_lantmannen '50-40-5-5 137 2-1/frap_004.mat'], ...
                [main_folder_lantmannen '50-40-5-5 137 2-1/frap_005.mat'], ...
                [main_folder_lantmannen '50-40-5-5 137 2-1/frap_006.mat'], ...
                [main_folder_lantmannen '50-40-5-5 137 2-1/frap_007.mat'], ...
                [main_folder_lantmannen '50-40-5-5 137 2-1/frap_008.mat'], ...
                [main_folder_lantmannen '50-40-5-5 137 2-1/frap_009.mat'], ...
                [main_folder_lantmannen '50-40-5-5 137 2-1/frap_010.mat'], ...
                [main_folder_lantmannen '50-45-5 132 1-1/frap.mat'], ...
                [main_folder_lantmannen '50-45-5 132 1-1/frap_001.mat'], ...
                [main_folder_lantmannen '50-45-5 132 1-1/frap_002.mat'], ...
                [main_folder_lantmannen '50-45-5 132 1-1/frap_003.mat'], ...
                [main_folder_lantmannen '50-45-5 132 1-1/frap_004.mat'], ...
                [main_folder_lantmannen '50-45-5 132 1-1/frap_005.mat'], ...
                [main_folder_lantmannen '50-45-5 132 1-1/frap_006.mat'], ...
                [main_folder_lantmannen '50-45-5 132 1-1/frap_007.mat'], ...
                [main_folder_lantmannen '50-45-5 180 1-2/frap.mat'], ...
                [main_folder_lantmannen '50-45-5 180 1-2/frap_001.mat'], ...
                [main_folder_lantmannen '50-45-5 180 1-2/frap_002.mat'], ...
                [main_folder_lantmannen '50-45-5 180 1-2/frap_003.mat'], ...
                [main_folder_lantmannen '50-45-5 180 1-2/frap_004.mat'], ...
                [main_folder_lantmannen '50-45-5 180 1-2/frap_005.mat'], ...
                [main_folder_lantmannen '50-45-5 180 1-2/frap_006.mat'], ...
                [main_folder_lantmannen '50-45-5 180 1-2/frap_007.mat'], ...
                [main_folder_lantmannen 'buffertar/frap.mat'], ...
                [main_folder_lantmannen 'buffertar/frap_001.mat'], ...
                [main_folder_lantmannen 'buffertar/frap_002.mat'], ...
                [main_folder_lantmannen 'buffertar/frap_003.mat'], ...
                [main_folder_lantmannen 'buffertar/frap_004.mat'], ...
                [main_folder_lantmannen 'buffertar/frap_005.mat']};
            
%% Settings.
number_of_pad_pixels = 128;

%% Loop through experiments.

M1 = cell(0);
M2 = cell(0);
M3 = cell(0);
M4 = cell(0);

number_of_experiments = numel(file_paths);

param_hat_d_with_prebleach = cell(number_of_experiments, 1);
param_hat_d_without_prebleach = cell(number_of_experiments, 1);
ss_d_with_prebleach = inf(number_of_experiments, 1);
ss_d_without_prebleach = inf(number_of_experiments, 1);

for current_experiment = 1:number_of_experiments
    disp(['Reading data from ' file_paths{current_experiment} '...'])

    % Load and process data.
    load(file_paths{current_experiment});

    data_prebleach = experiment.prebleach.image_data;
    data_prebleach = double(data_prebleach);
    data_prebleach = data_prebleach / (2^experiment.prebleach.bit_depth - 1);

    data = experiment.postbleach.image_data;
    data = double(data);
    data = data / (2^experiment.postbleach.bit_depth - 1);

    number_of_images_prebleach = size(data_prebleach, 3);
    number_of_images = size(data, 3);

    data_prebleach_avg = mean(data_prebleach, 3);

    data_prebleach = data_prebleach - repmat(data_prebleach_avg, [1, 1, number_of_images_prebleach]) + mean(data_prebleach_avg(:));
    data = data - repmat(data_prebleach_avg, [1, 1, number_of_images]) + mean(data_prebleach_avg(:));

    number_of_pixels = size(experiment.postbleach.image_data, 1);
    x_bleach =  - experiment.bleach.bleach_position_x / experiment.postbleach.pixel_size_x + number_of_pixels / 2;
    y_bleach = experiment.bleach.bleach_position_y / experiment.postbleach.pixel_size_y + number_of_pixels / 2;

    if isequal(experiment.bleach.bleach_type, 'circle')
        r_bleach = 0.5 * experiment.bleach.bleach_size_x / experiment.postbleach.pixel_size_x;
        param_bleach = [x_bleach, y_bleach, r_bleach];
    elseif isequal(experiment.bleach.bleach_type, 'rectangle')
        lx_bleach = experiment.bleach.bleach_size_x / experiment.postbleach.pixel_size_x;
        ly_bleach = experiment.bleach.bleach_size_y / experiment.postbleach.pixel_size_y;
        param_bleach = [x_bleach, y_bleach, lx_bleach, ly_bleach];
    end

    pixel_size = experiment.postbleach.pixel_size_x;
    delta_t = experiment.postbleach.time_frame;
    
    % Create folder for saving results.
    folder = [file_paths{current_experiment}(1:end-4) '_results'];
    if exist(folder) ~= 7
        mkdir(folder);
    end
    
    % D estimates.
    is_d_with_prebleach_estimate = false;
    files_estimates = dir([file_paths{current_experiment}(1:end-4) '_est_d_rc_with_prebleach*']);
    number_of_estimates = numel(files_estimates);
    if number_of_estimates >= 1
        is_d_with_prebleach_estimate = true;
        
        disp(['   Reading D (with prebleach) estimates from ' num2str(number_of_estimates) ' files...'])
        for current_estimate = 1:number_of_estimates
            data_est = load([files_estimates(current_estimate).folder '/' files_estimates(current_estimate).name]);

            if data_est.ss < ss_d_with_prebleach(current_experiment)
                param_hat_d_with_prebleach{current_experiment} = data_est.param_hat;
                ss_d_with_prebleach(current_experiment) = data_est.ss;
            end        
        end
    end
    
    % DB estimates.
    is_d_without_prebleach_estimate = false;
    files_estimates = dir([file_paths{current_experiment}(1:end-4) '_est_d_rc_without_prebleach*']);
    number_of_estimates = numel(files_estimates);
    if number_of_estimates >= 1
        is_d_without_prebleach_estimate = true;
        
        disp(['   Reading D (without prebleach) estimates from ' num2str(number_of_estimates) ' files...'])
        for current_estimate = 1:number_of_estimates
            data_est = load([files_estimates(current_estimate).folder '/' files_estimates(current_estimate).name]);

            if data_est.ss < ss_d_without_prebleach(current_experiment)
                param_hat_d_without_prebleach{current_experiment} = data_est.param_hat;
                ss_d_without_prebleach(current_experiment) = data_est.ss;
            end        
        end
    end
    
    % Plot and save recovery curve(s).
        
    [X, Y] = meshgrid(1:number_of_pixels, 1:number_of_pixels);
    X = X - 0.5;
    Y = Y - 0.5;

    if numel(param_bleach) == 3 % Circular.
        ind = find( (X - x_bleach).^2 + (Y - y_bleach).^2 <= r_bleach^2 );
    else % Rectangular.
        ind = find( X >= x_bleach - 0.5 * lx_bleach & X <= x_bleach + 0.5 * lx_bleach & Y >= y_bleach - 0.5 * ly_bleach & Y <= y_bleach + 0.5 * ly_bleach );
    end
    ind = ind(:);

    rc_data_prebleach = zeros(1, number_of_images_prebleach);
    for current_image = 1:number_of_images_prebleach
        slice = data_prebleach(:, :, current_image);
        rc_data_prebleach(current_image) = mean(slice(ind));
    end
    
    rc_data = zeros(1, number_of_images);
    for current_image = 1:number_of_images
        slice = data(:, :, current_image);
        rc_data(current_image) = mean(slice(ind));
    end
    
    
    if is_d_with_prebleach_estimate
        model_d_with_prebleach = signal_d( ...
            param_hat_d_with_prebleach{current_experiment}(1), ...
            param_hat_d_with_prebleach{current_experiment}(2), ...
            param_hat_d_with_prebleach{current_experiment}(3), ...
            param_hat_d_with_prebleach{current_experiment}(4), ...
            param_bleach, ...
            delta_t, ...
            number_of_pixels, ...
            number_of_images, ...
            number_of_pad_pixels);
        
        rc_model_prebleach = param_hat_d_with_prebleach{current_experiment}(4) * ones(1, number_of_images_prebleach);
        
        rc_model = zeros(1, number_of_images);
        for current_image = 1:number_of_images
            slice = model_d_with_prebleach(:, :, current_image);
            rc_model(current_image) = mean(slice(ind));
        end
        
        figure, hold on
        plot(([-number_of_images_prebleach:-1 1:number_of_images])*delta_t, [rc_data_prebleach rc_data], 'ko');
        
        plot(([-number_of_images_prebleach:-1 1:number_of_images])*delta_t, [rc_model_prebleach rc_model], 'b-');
        
        xlabel('Time (s)');
        ylabel('Mean bleach region intensity (a.u.)')
        box on
        print(gcf, [folder '/' 'recovery_curve_rc_d_with_prebleach.png'], '-dpng');
    end
    
    if is_d_without_prebleach_estimate
        model_d_without_prebleach = signal_d( ...
            param_hat_d_without_prebleach{current_experiment}(1), ...
            param_hat_d_without_prebleach{current_experiment}(2), ...
            param_hat_d_without_prebleach{current_experiment}(3), ...
            param_hat_d_without_prebleach{current_experiment}(4), ...
            param_bleach, ...
            delta_t, ...
            number_of_pixels, ...
            number_of_images, ...
            number_of_pad_pixels);
        
        rc_model_prebleach = param_hat_d_without_prebleach{current_experiment}(4) * ones(1, number_of_images_prebleach);
        
        rc_model = zeros(1, number_of_images);
        for current_image = 1:number_of_images
            slice = model_d_without_prebleach(:, :, current_image);
            rc_model(current_image) = mean(slice(ind));
        end
        
        figure, hold on
        plot(([-number_of_images_prebleach:-1 1:number_of_images])*delta_t, [rc_data_prebleach rc_data], 'ko');
        
        plot(([-number_of_images_prebleach:-1 1:number_of_images])*delta_t, [rc_model_prebleach rc_model], 'b-');
        
        xlabel('Time (s)');
        ylabel('Mean bleach region intensity (a.u.)')
        box on
        print(gcf, [folder '/' 'recovery_curve_rc_d_without_prebleach.png'], '-dpng');
    end
    
    close all
    
    % Prepare and save parameter estimates to file.
%     if is_d_estimate
        D_d_with_prebleach = param_hat_d_with_prebleach{current_experiment}(1) * pixel_size^2;
        mf_d_with_prebleach = param_hat_d_with_prebleach{current_experiment}(2);
%         Ib_d = param_hat_d_with_prebleach{current_experiment}(3);
%         Iu_d = param_hat_d_with_prebleach{current_experiment}(4);
%         
%         sum_of_squares_d = ss_d_with_prebleach(current_experiment);
%     end
%     
%     if is_d_without_prebleach_estimate
        D_d_without_prebleach = param_hat_d_without_prebleach{current_experiment}(1) * pixel_size^2;
%         k_on_db = param_hat_d_without_prebleach{current_experiment}(2);
%         k_off_db = param_hat_d_without_prebleach{current_experiment}(3);
%         mf_d_without_prebleach = param_hat_d_without_prebleach{current_experiment}(4);
%         Ib_db = param_hat_d_without_prebleach{current_experiment}(5);
%         Iu_db = param_hat_d_without_prebleach{current_experiment}(6);
%         
%         sum_of_squares_db = ss_d_without_prebleach(current_experiment);
%     end
%     
%     if is_d_estimate && is_d_without_prebleach_estimate
%         save([folder '/' 'estimates_rc.mat'], 'D_d', 'mf_d', 'Ib_d', 'Iu_d', 'D_db', 'k_on_db', 'k_off_db', 'mf_db', 'Ib_db', 'Iu_db', 'sum_of_squares_d', 'sum_of_squares_db');
%     elseif is_d_estimate && ~is_d_without_prebleach_estimate
%         save([folder '/' 'estimates_rc.mat'], 'D_d', 'mf_d', 'Ib_d', 'Iu_d', 'sum_of_squares_d');
%     elseif ~is_d_estimate && is_d_without_prebleach_estimate
%         save([folder '/' 'estimates_rc.mat'], 'D_db', 'k_on_db', 'k_off_db', 'mf_db', 'Ib_db', 'Iu_db', 'sum_of_squares_db');
%     end
    
    M1 = cat(1, M1, file_paths{current_experiment});
    M2 = cat(1, M2, num2str(D_d_with_prebleach));
    M3 = cat(1, M3, num2str(mf_d_with_prebleach));
    M4 = cat(1, M4, num2str(D_d_without_prebleach));
 
end

MT = table(M1, M2, M3, M4);
writetable(MT, [main_folder_lantmannen 'results.txt']);
